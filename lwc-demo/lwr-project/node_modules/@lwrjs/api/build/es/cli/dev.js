import chalk from 'chalk';
import { logger } from '@lwrjs/diagnostics';
import { launch } from '@lwrjs/shared-utils';
import { DEFAULT_PROXY_PORT, createProxyServer, findProxyConfiguration } from '@lwrjs/dev-proxy-server';
export async function dev(options) {
    const { port, mode, rootDir, config, open, logLevel } = options;
    const { createServer } = await import('@lwrjs/core');
    process.env.LWR_LOG_LEVEL = logLevel; // Set the log level
    // runtimePort can be undefined on invocation. The actual value is resolved via createServer()
    let runtimePort = port;
    const proxyPort = port === undefined ? DEFAULT_PROXY_PORT : port;
    try {
        const proxyConfig = findProxyConfiguration(rootDir);
        if (proxyConfig) {
            runtimePort = proxyPort + 1;
            // start an express proxy
            const proxyServer = createProxyServer({
                port: proxyPort,
                // TODO: expose this as a configurable property.
                defaultHost: `http://localhost:${runtimePort}`,
                ...proxyConfig,
            });
            await proxyServer.listen();
        }
        const server = createServer({
            port: runtimePort,
            serverMode: mode,
            rootDir,
            lwrConfigFile: config,
        });
        await server.listen(async ({ serverMode, port: appPort }) => {
            runtimePort = appPort;
        });
        const sitePort = proxyConfig !== undefined ? proxyPort : runtimePort;
        // TODO
        // eslint-disable-next-line no-console
        console.log(chalk.green(`Application is available at: http://localhost:${sitePort}`));
        if (open) {
            await launch(sitePort);
        }
    }
    catch (error) {
        logger.error(error);
        process.exit(1);
    }
}
//# sourceMappingURL=dev.js.map