import chalk from 'chalk';
import { logger } from '@lwrjs/diagnostics';
import { launch } from '@lwrjs/shared-utils';
import path from 'path';
import fs from 'fs-extra';
export async function expBundle(options) {
    const { port, open, logLevel, all, outputDir, timeout } = options;
    process.env.LWR_LOG_LEVEL = logLevel; // Set the log level
    if (timeout) {
        process.env.SSR_TIMEOUT = `${timeout}`;
    }
    // TODO we will make this more robust in the future w/ full MRT HMR
    process.env.MRT_HMR = 'true';
    // Use server warmup to generate our views
    if (all)
        process.env.WARMUP = 'true';
    // runtimePort can be undefined on invocation. The actual value is resolved via createServer()
    let runtimePort = port;
    // Validate we have an ssr.js file in the app directory
    const ssrjs = path.join(process.cwd(), 'app', 'ssr.js');
    if (!fs.existsSync(ssrjs)) {
        logger.error('Could not find a valid ssr.js file. Please ensure you have an MRT bundle extracted locally in a directory named "app"');
        process.exit(1);
    }
    let server;
    try {
        const { createDevServer } = await import('../localdev/dev-server.js');
        server = await createDevServer(runtimePort, outputDir);
        await server.listen(async ({ serverMode, port: appPort }) => {
            runtimePort = appPort;
        });
        // TODO
        // eslint-disable-next-line no-console
        console.log(chalk.green(`Application is available at: http://localhost:${runtimePort}.`));
        // eslint-disable-next-line no-console
        console.log(chalk.yellow(`NOTE: Any routes you navigate to in your browser will be compiled from local source and packaged directly into MRT prod bundles. Use at your own risk!`));
        if (open) {
            await launch(runtimePort);
        }
    }
    catch (error) {
        logger.error(error);
        process.exit(1);
    }
}
//# sourceMappingURL=exp-bundle.js.map